<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Earning Platform — Final</title>

<!-- Monetag / LibTL SDK (you already had this) -->
<script src="//libtl.com/sdk.js" data-zone="9789039" data-sdk="show_9789039"></script>

<style>
:root{
  --bg:#0f1720; --card:#111827; --muted:#9ca3af; --accent:#06b6d4; --success:#10b981; --danger:#ef4444; --btn:#2563eb;
  --white:#ffffff;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--white);padding:18px;display:flex;justify-content:center}
.container{width:100%;max-width:520px}
.header{margin-bottom:18px;text-align:center}
.header h1{margin:0;font-size:22px}
.header p{margin:6px 0 0;color:var(--muted)}
.card{background:var(--card);border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:18px;margin-bottom:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
.balance{font-size:32px;font-weight:700;margin:6px 0}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;margin-top:12px}
.grid .item h3{margin:0;font-size:20px}
.grid .item p{margin:6px 0 0;color:var(--muted);font-size:13px}
.btn{width:100%;padding:14px;border-radius:10px;border:none;font-weight:700;font-size:15px;background:linear-gradient(135deg,var(--btn),#1d4ed8);color:var(--white);cursor:pointer;transition:transform .12s,box-shadow .12s}
.btn:active{transform:scale(.995)}
.btn.small{padding:10px;font-size:14px}
.btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
.controls{display:flex;gap:10px;flex-direction:column}
.highlight{display:inline-block;padding:10px 14px;border-radius:999px;background:#ef4444;color:#fff;font-weight:700;margin-bottom:12px}
.status{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:10px;border-left:4px solid var(--accent);display:none}
.notice{margin-top:10px;padding:10px;background:#7c2d12;border-radius:8px;color:#fff;display:none}
.footer{position:fixed;left:0;right:0;bottom:0;padding:10px 18px;background:rgba(0,0,0,0.25);display:flex;justify-content:space-between;align-items:center;border-top:1px solid rgba(255,255,255,0.02)}
.smallmuted{color:var(--muted);font-size:13px}
.payment-icons{display:flex;gap:10px;margin-top:10px}
.payment-icons img{width:44px;height:30px;object-fit:contain;border-radius:6px;cursor:pointer;border:2px solid transparent}
.payment-icons img.selected{border-color:var(--accent)}
.nav{display:flex;gap:8px;justify-content:center;margin-top:8px}
.nav button{background:none;border:none;color:var(--muted);cursor:pointer;padding:8px;border-radius:8px}
.nav button.active{color:var(--accent)}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Earning Platform</h1>
      <p>Watch Ads • Earn USDT</p>
    </div>

    <div class="card" id="homeCard">
      <div class="highlight">সম্পূর্ণ AD না দেখলে কাজ গন্য হবে না</div>
      <h2 style="margin:8px 0 0 0">Current balance</h2>
      <div class="balance" id="balanceDisplay">USDT 0.00</div>

      <div class="grid">
        <div class="item">
          <h3 id="adCountDisplay">0</h3>
          <p>Total Ads Watched</p>
        </div>
        <div class="item">
          <h3 id="dailyAdCountDisplay">0 / 20</h3>
          <p>Today's Ads</p>
        </div>
        <div class="item">
          <h3 id="dailySignupCountDisplay">0 / 1</h3>
          <p>Today's Sign-ups</p>
        </div>
      </div>

      <div style="margin-top:14px" class="controls">
        <button class="btn" id="watchNowBtn">Watch Now</button>
        <button class="btn" id="signupBtn" disabled>Sign-up</button>
        <div id="signupNote" class="notice">১৫ টি কাজ সম্পূর্ণ হয়েছে! Sign-up করতে নিচের বাটনে ক্লিক করুন।</div>
      </div>
    </div>

    <div class="card" id="refCard" style="display:none">
      <h2>Referral</h2>
      <p class="smallmuted">Share your link</p>
      <div style="margin-top:8px;background:#0b1220;padding:10px;border-radius:8px" id="refLink">https://t.me/Monetag_alamin_bot</div>
    </div>

    <div class="card" id="withdrawCard" style="display:none">
      <h2>Withdraw</h2>
      <p class="smallmuted">Choose platform (Min 20 USDT)</p>
      <div class="payment-icons">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6f/Binance_Logo.png" alt="Binance" id="binanceBtn">
        <img src="https://upload.wikimedia.org/wikipedia/commons/5/5d/Bybit_logo.png" alt="Bybit" id="bybitBtn">
        <img src="https://www.paypalobjects.com/webstatic/icon/pp258.png" alt="PayPal" id="paypalBtn">
        <img src="" alt="Uwoln" id="uwolnBtn" style="background:#111;width:44px;height:30px">
      </div>
      <div style="margin-top:12px">
        <button class="btn small" id="mainWithdrawBtn" disabled>Withdraw</button>
      </div>
    </div>

    <div class="nav">
      <button id="navHome" class="active">Home</button>
      <button id="navReferral">Referral</button>
      <button id="navWithdraw">Withdraw</button>
    </div>

  </div>

  <div id="status" class="status"></div>

  <div class="footer">
    <div class="smallmuted" id="dateTimeDisplay"></div>
    <div class="smallmuted">Built — Final</div>
  </div>

<script>
/* ===========================
   FINAL app script (Bangla messages)
   Features:
   - Watch Now always enabled (but must meet 15s rule to credit)
   - Monetag SDK integration (supports show_9789039(...) or MonetagSDK.showAd(...))
   - Credit only when SDK reports completed AND 15s watched
   - Sign-up unlock after 15 ads, runs an SDK ad and allowed once per day
   - Daily midnight reset
   - Persistent state via localStorage
   ============================= */

(function(){
  // DOM
  const balanceDisplay = document.getElementById('balanceDisplay');
  const adCountDisplay = document.getElementById('adCountDisplay');
  const dailyAdCountDisplay = document.getElementById('dailyAdCountDisplay');
  const dailySignupCountDisplay = document.getElementById('dailySignupCountDisplay');
  const watchNowBtn = document.getElementById('watchNowBtn');
  const signupBtn = document.getElementById('signupBtn');
  const signupNote = document.getElementById('signupNote');
  const statusEl = document.getElementById('status');
  const dateTimeDisplay = document.getElementById('dateTimeDisplay');
  const navHome = document.getElementById('navHome');
  const navReferral = document.getElementById('navReferral');
  const navWithdraw = document.getElementById('navWithdraw');
  const homeCard = document.getElementById('homeCard');
  const refCard = document.getElementById('refCard');
  const withdrawCard = document.getElementById('withdrawCard');
  const mainWithdrawBtn = document.getElementById('mainWithdrawBtn');
  const binanceBtn = document.getElementById('binanceBtn');
  const bybitBtn = document.getElementById('bybitBtn');
  const paypalBtn = document.getElementById('paypalBtn');
  const uwolnBtn = document.getElementById('uwolnBtn');

  // Config
  const AD_MIN_MS = 15000;           // 15 seconds required
  const AD_REWARD_CENTS = 2;         // 0.02 USDT -> stored in cents
  const DAILY_AD_LIMIT = 20;
  const SIGNUP_THRESHOLD = 15;
  const WITHDRAW_THRESHOLD_CENTS = 2000; // 20 USDT

  // state stored in localStorage. structure:
  // { balanceInCents, totalAdCount, dailyAdCount, dailySignupCount, lastResetDate, signupDate }
  let state = {
    balanceInCents: 0,
    totalAdCount: 0,
    dailyAdCount: 0,
    dailySignupCount: 0,
    lastResetDate: null,    // YYYY-MM-DD of last reset
    signupDate: null        // YYYY-MM-DD when signup done
  };

  // runtime helpers
  let currentAdSessionId = 0;   // unique id per ad attempt; used to avoid duplicate credits
  const STORAGE_KEY = 'earningState_v1_final';

  // load state
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) {
        const s = JSON.parse(raw);
        state = Object.assign(state, s || {});
      }
    }catch(e){ console.error('loadState', e); }
    // if lastResetDate not today -> reset daily counters
    const today = getToday();
    if(state.lastResetDate !== today){
      state.dailyAdCount = 0;
      state.dailySignupCount = 0;
      state.lastResetDate = today;
      state.signupDate = null; // allow signup again each day
      saveState();
    }
  }

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.error('save', e); }
  }

  function getToday(){ return new Date().toISOString().split('T')[0]; }

  // UI helpers
  let statusTimer = null;
  function showStatus(msg, type='info', dur=3000){
    clearTimeout(statusTimer);
    statusEl.style.display = 'block';
    statusEl.textContent = msg;
    statusEl.style.borderLeft = (type==='success')? '4px solid var(--success)' : (type==='error'? '4px solid var(--danger)' : '4px solid var(--accent)');
    statusTimer = setTimeout(()=>{ statusEl.style.display='none'; }, dur);
  }

  function updateUI(){
    balanceDisplay.textContent = `USDT ${(state.balanceInCents/100).toFixed(2)}`;
    adCountDisplay.textContent = state.totalAdCount;
    dailyAdCountDisplay.textContent = `${state.dailyAdCount} / ${DAILY_AD_LIMIT}`;
    dailySignupCountDisplay.textContent = `${state.dailySignupCount} / 1`;

    // signup logic: available if totalAdCount >= threshold and user hasn't signed up today
    const signedUpToday = (!!state.signupDate && state.signupDate === getToday());
    if(state.totalAdCount >= SIGNUP_THRESHOLD && !signedUpToday && state.dailySignupCount < 1){
      signupBtn.disabled = false;
      signupNote.style.display = 'block';
    } else {
      signupBtn.disabled = true;
      signupNote.style.display = 'none';
    }

    // withdraw enable
    mainWithdrawBtn.disabled = !(state.balanceInCents >= WITHDRAW_THRESHOLD_CENTS);
  }

  // schedule midnight reset (also correct for timezone of browser)
  function scheduleMidnightReset(){
    const now = new Date();
    const midnight = new Date();
    midnight.setHours(24,0,0,0); // next midnight
    const timeout = midnight.getTime() - now.getTime();
    setTimeout(()=>{
      // reset daily counters
      state.dailyAdCount = 0;
      state.dailySignupCount = 0;
      state.lastResetDate = getToday();
      state.signupDate = null;
      saveState();
      updateUI();
      showStatus('Daily counters reset!', 'info', 3000);
      scheduleMidnightReset(); // schedule next
    }, timeout + 1000); // slight buffer
  }

  // SDK wrapper - tries different SDK shapes and passes onClose callback
  function callSdkShowAd({onClose, adType='generic'}){
    // Keep local id to ensure we credit only for this specific session
    const sessionId = ++currentAdSessionId;
    // Try global show_9789039 if present
    try{
      if(typeof show_9789039 === 'function'){
        // many of these SDKs accept an object with onClose or callback
        try{
          show_9789039({
            // if SDK supports passing extra info, you could send adType here
            onClose: function(completed){
              // ensure we only run for current session
              onClose && onClose({completed: !!completed, sessionId});
            }
          });
          return { used: true };
        }catch(e){
          console.warn('show_9789039 invocation failed', e);
        }
      }
      // Try MonetagSDK.showAd(...) shape
      if(window.MonetagSDK && typeof MonetagSDK.showAd === 'function'){
        try{
          MonetagSDK.showAd({
            // pass adType or zone if needed
            onComplete: function(){ onClose && onClose({completed:true, sessionId}); },
            onClose: function(){ onClose && onClose({completed:false, sessionId}); },
            onError: function(){ onClose && onClose({completed:false, sessionId}); }
          });
          return { used: true };
        }catch(e){ console.warn('MonetagSDK.showAd error', e); }
      }
    }catch(e){
      console.error('SDK call wrapper error', e);
    }

    // Fallback: simulate an ad by waiting AD_MIN_MS and then call back as completed
    setTimeout(()=>{ onClose && onClose({completed:true, sessionId}); }, AD_MIN_MS + 200);
    return { used:false };
  }

  // Credit logic: only credit once per SDK session id
  const creditedSessions = new Set();
  function tryCreditFromSession(sessionId){
    if(!sessionId) return;
    if(creditedSessions.has(sessionId)) return;
    creditedSessions.add(sessionId);
    // credit
    state.totalAdCount++;
    state.dailyAdCount++;
    state.balanceInCents += AD_REWARD_CENTS;
    saveState();
    updateUI();
    showStatus('+0.02 USDT যোগ হয়েছে', 'success', 3000);
  }

  // Watch Ad (user presses Watch Now)
  function onWatchNowClicked(){
    // check daily limit
    if(state.dailyAdCount >= DAILY_AD_LIMIT){
      showStatus('আপনি আজকে daily limit পৌঁছেছেন', 'error', 3000);
      return;
    }

    // record start time for this session
    const startTs = Date.now();
    let thisSessionId = null;

    showStatus('Ad লোড হচ্ছে... ১৫ সেকেন্ড পর্যন্ত দেখুন', 'info', 3500);

    callSdkShowAd({
      adType: 'watch',
      onClose: function({completed, sessionId}){
        thisSessionId = sessionId;
        const watchedMs = Date.now() - startTs;
        const watchedEnough = watchedMs >= AD_MIN_MS;
        if(completed && watchedEnough){
          tryCreditFromSession(sessionId);
        } else {
          // not enough or not completed
          showStatus('Ad সম্পূর্ণ দেখা হয়নি — আবার চেষ্টা করুন', 'error', 3000);
        }
      }
    });

    // Note: Watch Now button must stay enabled per request — so we DO NOT disable it.
  }

  // Sign-up flow: runs SDK ad and marks signup for today (only once/day)
  function onSignupClicked(){
    const signedUpToday = (state.signupDate === getToday());
    if(signedUpToday || state.dailySignupCount >= 1){
      showStatus('আপনি আজ ইতোমধ্যে Sign-up করেছেন', 'info', 2500);
      return;
    }
    if(state.totalAdCount < SIGNUP_THRESHOLD){
      showStatus('প্রথমে ১৫টি Ad শেষ করুন', 'error', 2500);
      return;
    }

    showStatus('Sign-up এড লোড হচ্ছে — দয়া করে সম্পূর্ণ দেখুন', 'info', 3500);
    const startTs = Date.now();
    let thisSessionId = null;

    callSdkShowAd({
      adType: 'signup',
      onClose: function({completed, sessionId}){
        thisSessionId = sessionId;
        const watchedMs = Date.now() - startTs;
        if(completed && watchedMs >= AD_MIN_MS){
          // mark signup
          state.dailySignupCount = (state.dailySignupCount||0) + 1;
          state.signupDate = getToday();
          state.lastResetDate = state.lastResetDate || getToday();
          saveState();
          updateUI();
          showStatus('Sign-up সম্পন্ন হয়েছে — ধন্যবাদ!', 'success', 4000);
        } else {
          showStatus('Sign-up এড সম্পূর্ণ হয়নি — আবার চেষ্টা করুন', 'error', 3000);
        }
      }
    });
  }

  // Withdraw platform select (simple)
  function selectPlatform(btn){
    [binanceBtn,bybitBtn,paypalBtn,uwolnBtn].forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    // set platform name on variable if needed
  }

  // Navigation
  function showView(view){
    homeCard.style.display = (view==='home') ? 'block' : 'none';
    refCard.style.display = (view==='ref') ? 'block' : 'none';
    withdrawCard.style.display = (view==='withdraw') ? 'block' : 'none';
    [navHome,navReferral,navWithdraw].forEach(n=>n.classList.remove('active'));
    if(view==='home') navHome.classList.add('active');
    if(view==='ref') navReferral.classList.add('active');
    if(view==='withdraw') navWithdraw.classList.add('active');
  }

  // Date/time display
  function startClock(){
    setInterval(()=>{
      const now = new Date();
      dateTimeDisplay.textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    }, 1000);
  }

  // init
  function init(){
    loadState();
    updateUI();
    scheduleMidnightReset();
    startClock();

    // attach listeners
    watchNowBtn.addEventListener('click', onWatchNowClicked);
    signupBtn.addEventListener('click', onSignupClicked);
    navHome.addEventListener('click', ()=>showView('home'));
    navReferral.addEventListener('click', ()=>showView('ref'));
    navWithdraw.addEventListener('click', ()=>showView('withdraw'));
    binanceBtn.addEventListener('click', ()=>selectPlatform(binanceBtn));
    bybitBtn.addEventListener('click', ()=>selectPlatform(bybitBtn));
    paypalBtn.addEventListener('click', ()=>selectPlatform(paypalBtn));
    uwolnBtn.addEventListener('click', ()=>selectPlatform(uwolnBtn));

    // keep signupNote visibility correct after load
    updateUI();
  }

  // run
  init();

  // Expose some helpers for debugging (optional)
  window.EARNING_APP = {
    getState: ()=>state,
    resetAll: ()=>{ state = {balanceInCents:0,totalAdCount:0,dailyAdCount:0,dailySignupCount:0,lastResetDate:getToday(),signupDate:null}; saveState(); updateUI(); showStatus('Reset done (debug)', 'info'); }
  };

})();
</script>
</body>
</html>
